---
# tasks file for copy_files
- name: Ensure local download directory exists
  delegate_to: localhost
  become: false
  ansible.builtin.file:
    path: "{{ setup.graid_path }}"
    state: directory
    mode: "0755"

- name: Ensure download directory exists
  become: true
  ansible.builtin.file:
    path: "{{ setup.graid_path }}"
    state: directory
    mode: "0755"

- name: Check if the nv_driver file exists
  delegate_to: localhost
  ansible.builtin.stat:
    path: "{{ setup.graid_path }}{{ linux.nv_url | basename }}"
  register: nv_driver_stats

- name: Check if installers exist on control node
  delegate_to: localhost
  ansible.builtin.stat:
    path: "{{ setup.graid_path }}{{ item | basename }}"
  loop: "{{ linux.installer_urls }}"
  register: installer_stats

- name: Check if the pre-installer file exists
  delegate_to: localhost
  ansible.builtin.stat:
    path: "{{ setup.graid_path }}{{ linux.pre_installer_url | basename }}"
  register: pre_installer_stats

- name: Download nv_driver to control node
  delegate_to: localhost
  become: false
  ansible.builtin.get_url:
    url: "{{ linux.nv_url }}"
    dest: "{{ setup.graid_path }}{{ linux.nv_url | basename }}"
    mode: "0755"
  when:
    - ansible_os_family != "Windows"
    - not nv_driver_stats.stat.exists

- name: Download pre-installer to control node
  delegate_to: localhost
  become: false
  ansible.builtin.get_url:
    url: "{{ linux.pre_installer_url }}"
    dest: "{{ setup.graid_path }}{{ linux.pre_installer_url | basename }}"
    mode: "0755"
  when:
    - ansible_os_family != "Windows"
    - not pre_installer_stats.stat.exists

- name: Download installers to control node
  delegate_to: localhost
  become: false
  ansible.builtin.get_url:
    url: "{{ item.item }}"
    dest: "{{ setup.graid_path }}{{ item.item | basename }}"
    mode: "0755"
  loop: "{{ installer_stats.results }}"
  when:
    - ansible_os_family != "Windows"
    - not item.stat.exists

- name: Copy nv_driver to remote host
  become: true
  ansible.builtin.copy:
    src: "{{ setup.graid_path }}{{ linux.nv_url | basename }}"
    dest: "{{ setup.graid_path }}{{ linux.nv_url | basename }}"
    mode: "0755"
  when:
    - ansible_os_family != "Windows"

- name: Copy pre-installer to remote host
  become: true
  ansible.builtin.copy:
    src: "{{ setup.graid_path }}{{ linux.pre_installer_url | basename }}"
    dest: "{{ setup.graid_path }}{{ linux.pre_installer_url | basename }}"
    mode: "0755"
  when:
    - ansible_os_family != "Windows"

- name: Copy installers to remote host
  become: true
  ansible.builtin.copy:
    src: "{{ setup.graid_path }}{{ item.item | basename }}"
    dest: "{{ setup.graid_path }}{{ item.item | basename }}"
    mode: "0755"
  loop: "{{ installer_stats.results }}"
  when:
    - ansible_os_family != "Windows"

- name: Download nv dirver to control node
  become: false
  delegate_to: localhost
  ansible.builtin.get_url:
    url: "{{ windows.nv_url }}"
    dest: "{{ setup.graid_path }}{{ windows.nv_url | basename }}"
    mode: "0755"
  when:
    - ansible_os_family == "Windows"

- name: Download Installation script to control node
  become: false
  delegate_to: localhost
  ansible.builtin.get_url:
    url: "{{ windows.installation_script_url }}"
    dest: "{{ setup.graid_path }}{{ windows.installation_script_url | basename }}"
    mode: "0755"
  when:
    - ansible_os_family == "Windows"

- name: Download installers to control node
  become: false
  delegate_to: localhost
  ansible.builtin.get_url:
    url: "{{ item.item }}"
    dest: "{{ setup.graid_path }}{{ item.item | basename }}"
    mode: "0755"
  loop: "{{ windows.installer_win_urls }}"
  when:
    - ansible_os_family == "Windows"

- name: Copy nv dirver to remote host
  become: true
  ansible.windows.win_copy:
    src: "{{ setup.graid_path }}{{ windows.nv_url | basename }}"
    dest: "C:\\Temp\\{{ windows.nv_url | basename }}"
  when:
    - ansible_os_family == "Windows"

- name: Copy Installation script to remote host
  become: true
  ansible.windows.win_copy:
    src: "{{ setup.graid_path }}{{ windows.installation_script_url | basename }}"
    dest: "C:\\Temp\\{{ windows.installation_script_url | basename }}"
  when:
    - ansible_os_family == "Windows"

- name: Copy installers to remote host
  become: true
  ansible.windows.win_copy:
    src: "{{ setup.graid_path }}{{ item | basename }}"
    dest: "C:\\Temp\\{{ item | basename }}"
  loop: "{{ windows.installer_win_urls }}"
  when:
    - ansible_os_family == "Windows"
